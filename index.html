<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北海道冬日旅</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="北海道旅">
    <meta name="theme-color" content="#F1F5F9">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Noto Sans TC & Serif for Japanese feel -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Chart.js for Simple Stats (Optional but nice) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom Font Setup */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8FAFC; /* Slate 50 */
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .font-jp {
            font-family: 'Zen Old Mincho', serif;
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Splash Screen Animation */
        #splash-screen {
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .fade-out {
            opacity: 0;
            visibility: hidden;
        }

        /* Leaflet Map Fix */
        #map { height: 300px; width: 100%; border-radius: 1rem; z-index: 10; }

        /* Custom Colors based on Winter Theme */
        .bg-winter-light { background-color: #F0F9FF; } /* Sky 50 */
        .text-winter-dark { color: #1E293B; } /* Slate 800 */
        .accent-color { color: #0EA5E9; } /* Sky 500 */
        
        /* Smooth Tab Transition */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Safe Area Padding for Bottom Nav */
        .safe-pb {
            padding-bottom: calc(4rem + env(safe-area-inset-bottom));
        }

        /* Day Selector Active State */
        .day-btn.active {
            background-color: #0EA5E9;
            color: white;
            border-color: #0EA5E9;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
        }
    </style>
</head>
<body class="text-slate-700 h-screen w-screen overflow-hidden relative">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center">
        <div class="relative">
            <i class="fa-regular fa-snowflake text-6xl text-sky-300 animate-spin-slow" style="animation-duration: 3s;"></i>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa-solid fa-plane text-slate-600 text-xl"></i>
            </div>
        </div>
        <h1 class="mt-6 text-2xl font-jp tracking-widest text-slate-600">北海道</h1>
        <p class="text-slate-400 text-xs mt-2 tracking-widest uppercase">Winter Journey 2026</p>
        <div class="mt-8 w-32 h-1 bg-slate-200 rounded-full overflow-hidden">
            <div class="h-full bg-sky-400 w-full animate-pulse"></div>
        </div>
    </div>

    <!-- Top Navigation / Header -->
    <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md z-40 px-4 pt-12 pb-3 shadow-sm flex justify-between items-center border-b border-slate-100">
        <div>
            <h1 id="page-title" class="text-xl font-bold text-slate-800 font-jp">行程總覽</h1>
            <p id="page-subtitle" class="text-xs text-slate-500">Day 1 - Day 6</p>
        </div>
        <div class="flex gap-3">
             <button onclick="clearAllData()" class="text-slate-300 hover:text-red-400 transition"><i class="fa-solid fa-trash-can"></i></button>
            <div class="text-right">
                <div class="text-xs font-bold text-sky-600 bg-sky-50 px-2 py-1 rounded-lg" id="countdown">Loading...</div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="h-full overflow-y-auto pt-28 safe-pb px-4 no-scrollbar bg-slate-50" id="main-container">
        
        <!-- ================= PLAN TAB ================= -->
        <div id="tab-plan" class="tab-content active space-y-6">
            <!-- Flight Info Card -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-sky-500 text-white text-[10px] px-2 py-1 rounded-bl-lg">FLIGHTS</div>
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center w-1/3">
                        <div class="text-2xl font-bold text-slate-700">TPE</div>
                        <div class="text-xs text-slate-400">台北</div>
                    </div>
                    <div class="w-1/3 flex flex-col items-center">
                        <i class="fa-solid fa-plane text-sky-400"></i>
                        <div class="h-[1px] w-full bg-slate-200 my-1"></div>
                        <div class="text-[10px] text-slate-400">ROUND TRIP</div>
                    </div>
                    <div class="text-center w-1/3">
                        <div class="text-2xl font-bold text-slate-700">HKD/CTS</div>
                        <div class="text-xs text-slate-400">北海道</div>
                    </div>
                </div>
                <div class="space-y-2 text-xs text-slate-600 bg-slate-50 p-3 rounded-xl">
                    <div class="flex justify-between">
                        <span><i class="fa-solid fa-plane-departure mr-1 text-sky-500"></i> 去程: 虎航 TTW236</span>
                        <span class="font-mono">06:45 - 11:10</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-200 pt-2">
                        <span><i class="fa-solid fa-plane-arrival mr-1 text-sky-500"></i> 回程: 越捷 TVJ571</span>
                        <span class="font-mono">09:30 - 13:30</span>
                    </div>
                </div>
            </div>

            <!-- Accommodation Scroll -->
            <div class="overflow-x-auto no-scrollbar pb-2">
                <div class="flex gap-3 w-max">
                    <!-- Hotel 1 -->
                    <div class="w-64 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-500 shrink-0">
                            <i class="fa-solid fa-bed"></i>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 font-bold">DAY 1</div>
                            <div class="text-sm font-bold text-slate-700 truncate w-40">JR INN Hakodate</div>
                        </div>
                    </div>
                    <!-- Hotel 2 -->
                    <div class="w-64 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-orange-500 shrink-0">
                            <i class="fa-solid fa-hot-tub-person"></i>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 font-bold">DAY 2</div>
                            <div class="text-sm font-bold text-slate-700 truncate w-40">WE Hotel Toya</div>
                        </div>
                    </div>
                     <!-- Hotel 3 -->
                     <div class="w-64 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 shrink-0">
                            <i class="fa-solid fa-city"></i>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 font-bold">DAY 3-5</div>
                            <div class="text-sm font-bold text-slate-700 truncate w-40">Keio Prelia Sapporo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Day Selector -->
            <div class="sticky top-[-1px] z-20 bg-slate-50/95 backdrop-blur py-2 border-b border-slate-100 -mx-4 px-4 overflow-x-auto no-scrollbar flex gap-3" id="day-selector-container">
                <!-- JS will inject buttons -->
            </div>

            <!-- Daily Itinerary Container -->
            <div id="itinerary-container" class="space-y-6 pb-10 min-h-[400px]">
                <!-- Javascript will inject timeline here -->
            </div>
        </div>

        <!-- ================= GUIDE TAB ================= -->
        <div id="tab-guide" class="tab-content space-y-4">
             <!-- Map Section -->
             <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h3 class="font-bold text-slate-700 font-jp">景點地圖</h3>
                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">OpenStreetMap</span>
                </div>
                <div id="map"></div>
                <div class="mt-2 text-xs text-center text-slate-400">點擊地標查看詳情</div>
            </div>

            <div id="guide-cards" class="grid grid-cols-1 gap-4">
                <!-- JS will inject guide cards -->
            </div>
        </div>

        <!-- ================= WALLET TAB ================= -->
        <div id="tab-wallet" class="tab-content space-y-4">
            <!-- Rate Calculator -->
            <div class="bg-gradient-to-br from-indigo-900 to-slate-800 p-5 rounded-2xl text-white shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-jp text-lg">匯率計算機</h3>
                    <div class="text-right">
                        <label class="text-[10px] text-indigo-300 block">匯率 (JPY → TWD)</label>
                        <input type="number" id="exchange-rate" value="0.215" class="bg-transparent text-right text-sm font-mono border-b border-indigo-500 w-16 focus:outline-none" onchange="updateRate()">
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-indigo-300 text-xs">¥</span>
                        <input type="text" id="calc-input" placeholder="輸入算式 (如 500+200*3)" class="w-full bg-indigo-950/50 rounded-xl py-3 pl-8 pr-4 text-xl font-mono focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-indigo-300 text-sm">=</span>
                        <div class="text-3xl font-bold text-yellow-400 font-mono">NT$ <span id="calc-result">0</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 mt-4">
                    <button onclick="appendCalc('+')" class="bg-indigo-700/50 p-2 rounded-lg hover:bg-indigo-600 transition">+</button>
                    <button onclick="appendCalc('-')" class="bg-indigo-700/50 p-2 rounded-lg hover:bg-indigo-600 transition">-</button>
                    <button onclick="appendCalc('*')" class="bg-indigo-700/50 p-2 rounded-lg hover:bg-indigo-600 transition">×</button>
                    <button onclick="calculate()" class="bg-yellow-500 text-indigo-900 font-bold p-2 rounded-lg shadow-lg active:scale-95 transition">=</button>
                </div>
            </div>

            <!-- Add Expense -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 font-jp">新增記帳</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="expense-item" placeholder="品項名稱" class="w-full bg-slate-50 border-0 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-sky-200">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">¥</span>
                        <input type="number" id="expense-amount" placeholder="金額" class="w-full bg-slate-50 border-0 rounded-xl pl-6 pr-3 py-2 text-sm focus:ring-2 focus:ring-sky-200">
                    </div>
                </div>
                <div class="flex gap-3 mb-3">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="payment-type" value="cash" checked class="peer sr-only">
                        <div class="text-center py-2 rounded-xl bg-slate-50 text-slate-400 peer-checked:bg-green-100 peer-checked:text-green-600 transition text-sm">
                            <i class="fa-solid fa-money-bill"></i> 現金
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="payment-type" value="card" class="peer sr-only">
                        <div class="text-center py-2 rounded-xl bg-slate-50 text-slate-400 peer-checked:bg-purple-100 peer-checked:text-purple-600 transition text-sm">
                            <i class="fa-regular fa-credit-card"></i> 信用卡
                        </div>
                    </label>
                </div>
                <!-- Photo Upload -->
                 <div class="flex items-center gap-3">
                    <label class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-xl py-2 flex items-center justify-center gap-2 cursor-pointer transition">
                        <i class="fa-solid fa-camera"></i>
                        <span class="text-xs">拍照/上傳</span>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </label>
                    <button onclick="addExpense()" class="flex-1 bg-sky-500 text-white rounded-xl py-2 font-bold shadow-md active:scale-95 transition">
                        新增
                    </button>
                 </div>
                 <div id="image-preview-area" class="mt-2 hidden">
                     <span class="text-[10px] text-slate-400">已選圖片:</span>
                     <img id="temp-preview" class="h-16 w-auto rounded-lg border border-slate-200 mt-1 object-cover">
                 </div>
            </div>

            <!-- Expense List -->
            <div class="space-y-3 pb-20">
                <div class="flex justify-between items-end px-1">
                    <h3 class="font-bold text-slate-700 font-jp">消費紀錄</h3>
                    <div class="text-xs text-slate-500">總計: <span class="font-mono text-slate-800 font-bold" id="total-jpy">¥0</span></div>
                </div>
                <div id="expense-list" class="space-y-2">
                    <!-- JS Injected Items -->
                </div>
            </div>
        </div>

        <!-- ================= LISTS TAB ================= -->
        <div id="tab-lists" class="tab-content space-y-6">
            <!-- Checklist -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 font-jp border-b border-slate-100 pb-2">行前清單</h3>
                <div id="checklist-container" class="space-y-2">
                    <!-- JS Injected -->
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-check-item" placeholder="新增待辦..." class="flex-1 bg-slate-50 rounded-lg px-3 py-2 text-sm">
                    <button onclick="addCheckItem()" class="bg-slate-200 text-slate-600 px-4 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <!-- Memo -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 font-jp border-b border-slate-100 pb-2">備忘錄</h3>
                <textarea id="memo-area" class="w-full bg-yellow-50/50 p-3 rounded-xl text-sm leading-relaxed border border-yellow-100 h-40 focus:ring-2 focus:ring-yellow-200" placeholder="寫下你的筆記... (輸入連結會自動轉換)"></textarea>
                <button onclick="saveMemo()" class="mt-2 w-full bg-yellow-100 text-yellow-700 py-2 rounded-xl text-sm font-bold">儲存筆記</button>
            </div>
            
            <!-- Quick Links Preview -->
            <div id="memo-links" class="flex flex-wrap gap-2">
                <!-- Auto-generated links from memo -->
            </div>
        </div>

        <!-- ================= INFO TAB ================= -->
        <div id="tab-info" class="tab-content space-y-4">
             <!-- Weather -->
             <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="block bg-gradient-to-r from-sky-400 to-blue-500 p-4 rounded-2xl text-white shadow-md relative overflow-hidden group">
                <div class="absolute right-[-20px] top-[-20px] text-white/20 text-8xl">
                    <i class="fa-solid fa-cloud-sun"></i>
                </div>
                <div class="relative z-10">
                    <h3 class="font-bold text-lg">日本氣象廳</h3>
                    <p class="text-xs opacity-90 mt-1">查看北海道最新天氣預報 <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i></p>
                </div>
            </a>

            <!-- Emergency -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 font-jp">緊急聯絡</h3>
                <div class="grid grid-cols-3 gap-3">
                    <a href="tel:110" class="flex flex-col items-center bg-red-50 p-3 rounded-xl text-red-600">
                        <i class="fa-solid fa-shield-halved text-2xl mb-1"></i>
                        <span class="text-xs font-bold">警察 110</span>
                    </a>
                    <a href="tel:119" class="flex flex-col items-center bg-red-50 p-3 rounded-xl text-red-600">
                        <i class="fa-solid fa-truck-medical text-2xl mb-1"></i>
                        <span class="text-xs font-bold">救護 119</span>
                    </a>
                     <a href="https://www.roc-taiwan.org/jpsap/" target="_blank" class="flex flex-col items-center bg-blue-50 p-3 rounded-xl text-blue-600">
                        <i class="fa-solid fa-building-flag text-2xl mb-1"></i>
                        <span class="text-xs font-bold">辦事處</span>
                    </a>
                </div>
            </div>

            <!-- Rules -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 font-jp">注意事項</h3>
                <ul class="text-sm text-slate-600 space-y-3 list-disc pl-4">
                    <li><span class="font-bold text-slate-800">液體規範：</span>手提行李單瓶不超過100ml，需裝於1公升透明夾鏈袋。</li>
                    <li><span class="font-bold text-slate-800">行動電源：</span>必須手提，不可託運。</li>
                    <li><span class="font-bold text-slate-800">虎航行李：</span>手提最多10kg (54cm x 38cm x 23cm)。</li>
                    <li><span class="font-bold text-slate-800">入境：</span>請提前填寫 Visit Japan Web。</li>
                </ul>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-[env(safe-area-inset-bottom)] z-50">
        <div class="grid grid-cols-5 h-16">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center justify-center text-slate-400 hover:text-sky-500 transition group" data-target="plan">
                <div class="h-8 w-12 rounded-full flex items-center justify-center group-[.active]:bg-sky-50 group-[.active]:text-sky-600 transition">
                    <i class="fa-regular fa-calendar-days text-lg"></i>
                </div>
                <span class="text-[9px] mt-1 font-bold group-[.active]:text-sky-600">PLAN</span>
            </button>
            <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-sky-500 transition group" data-target="guide">
                 <div class="h-8 w-12 rounded-full flex items-center justify-center group-[.active]:bg-sky-50 group-[.active]:text-sky-600 transition">
                    <i class="fa-solid fa-map-location-dot text-lg"></i>
                </div>
                <span class="text-[9px] mt-1 font-bold group-[.active]:text-sky-600">GUIDE</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-sky-500 transition group" data-target="wallet">
                 <div class="h-8 w-12 rounded-full flex items-center justify-center group-[.active]:bg-sky-50 group-[.active]:text-sky-600 transition">
                    <i class="fa-solid fa-wallet text-lg"></i>
                </div>
                <span class="text-[9px] mt-1 font-bold group-[.active]:text-sky-600">WALLET</span>
            </button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-sky-500 transition group" data-target="lists">
                 <div class="h-8 w-12 rounded-full flex items-center justify-center group-[.active]:bg-sky-50 group-[.active]:text-sky-600 transition">
                    <i class="fa-solid fa-list-check text-lg"></i>
                </div>
                <span class="text-[9px] mt-1 font-bold group-[.active]:text-sky-600">LISTS</span>
            </button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center justify-center text-slate-400 hover:text-sky-500 transition group" data-target="info">
                 <div class="h-8 w-12 rounded-full flex items-center justify-center group-[.active]:bg-sky-50 group-[.active]:text-sky-600 transition">
                    <i class="fa-solid fa-circle-info text-lg"></i>
                </div>
                <span class="text-[9px] mt-1 font-bold group-[.active]:text-sky-600">INFO</span>
            </button>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================= DATA =================
        const itinerary = [
            {
                day: 1, date: "2026-03-19", title: "抵達函館 · 百萬夜景", color: "border-indigo-500",
                events: [
                    { time: "04:25", end: "06:25", title: "桃園機場 (出境)", desc: "預備起飛，記得提早到機場", icon: "fa-plane-departure", type: "transport" },
                    { time: "11:30", end: "12:30", title: "函館機場 (HKD)", desc: "抵達，準備入境", icon: "fa-plane-arrival", type: "transport" },
                    { time: "13:00", end: "13:20", title: "JR Inn Hakodate", desc: "辦理入住 / 暫存行李", icon: "fa-hotel", type: "stay", link: "https://maps.app.goo.gl/HakodateStation" },
                    { time: "13:23", end: "14:23", title: "幸運小丑漢堡", desc: "函館必吃！站前店", icon: "fa-burger", type: "food", link: "https://maps.app.goo.gl/vJbJgQhXwX9JtQj7A" },
                    { time: "14:51", end: "15:51", title: "五稜郭塔", desc: "俯瞰星形堡壘", icon: "fa-star", type: "sight" },
                    { time: "16:31", end: "16:56", title: "八幡坂", desc: "日劇名場景，直通大海的坡道", icon: "fa-road", type: "sight" },
                    { time: "17:05", end: "18:35", title: "函館山纜車", desc: "世界三大夜景之一", icon: "fa-mountain", type: "sight", highlight: true },
                    { time: "19:01", end: "", title: "JR Inn Hakodate", desc: "休息", icon: "fa-bed", type: "stay" }
                ]
            },
            {
                day: 2, date: "2026-03-20", title: "函館晨光 · 前往洞爺", color: "border-orange-500",
                events: [
                    { time: "08:00", end: "08:20", title: "飯店出發", desc: "開始今日行程", icon: "fa-person-walking", type: "transport" },
                    { time: "08:24", end: "09:24", title: "金森紅磚倉庫", desc: "港邊散步、伴手禮", icon: "fa-warehouse", type: "sight" },
                    { time: "09:25", end: "09:40", title: "星巴克 濱海店", desc: "看海喝咖啡", icon: "fa-mug-hot", type: "food" },
                    { time: "09:00", end: "", title: "取車", desc: "開始自駕之旅", icon: "fa-car", type: "transport", highlight: true },
                    { time: "09:49", end: "10:19", title: "函館八幡宮", desc: "莊嚴靜謐的神社", icon: "fa-torii-gate", type: "sight" },
                    { time: "12:53", end: "13:53", title: "昭和新山熊牧場", desc: "餵熊體驗", icon: "fa-paw", type: "sight" },
                    { time: "13:54", end: "14:54", title: "有珠山纜車", desc: "火山口景觀", icon: "fa-cable-car", type: "sight" },
                    { time: "17:53", end: "", title: "WE Hotel Toya", desc: "隈研吾設計飯店入住", icon: "fa-hotel", type: "stay" }
                ]
            },
            {
                day: 3, date: "2026-03-21", title: "登別地獄 · 札幌之夜", color: "border-blue-500",
                events: [
                    { time: "07:30", end: "08:30", title: "飯店出發", desc: "前往登別", icon: "fa-car", type: "transport" },
                    { time: "09:33", end: "11:33", title: "登別地獄谷", desc: "硫磺煙霧瀰漫", icon: "fa-fire", type: "sight" },
                    { time: "11:45", end: "13:45", title: "尼克斯海洋公園", desc: "企鵝遊行", icon: "fa-fish", type: "sight" },
                    { time: "15:08", end: "16:38", title: "白色戀人公園", desc: "如童話般的甜點工廠", icon: "fa-cookie-bite", type: "sight" },
                    { time: "17:01", end: "20:01", title: "Stellar Place", desc: "札幌車站購物", icon: "fa-bag-shopping", type: "food" },
                    { time: "20:05", end: "", title: "京王普雷利亞飯店", desc: "入住札幌", icon: "fa-hotel", type: "stay" }
                ]
            },
            {
                day: 4, date: "2026-03-22", title: "旭川動物與青池", color: "border-sky-500",
                events: [
                    { time: "08:00", end: "", title: "出發", desc: "前往旭川", icon: "fa-car", type: "transport" },
                    { time: "10:45", end: "12:45", title: "旭山動物園", desc: "冬天必看企鵝散步", icon: "fa-otter", type: "sight", highlight: true },
                    { time: "13:57", end: "14:17", title: "白鬚瀑布", desc: "絕美藍色瀑布", icon: "fa-water", type: "sight" },
                    { time: "14:24", end: "14:54", title: "白金青池", desc: "夢幻雪景", icon: "fa-snowflake", type: "sight" },
                    { time: "17:32", end: "18:02", title: "札幌電視塔", desc: "大通公園夜景", icon: "fa-tower-broadcast", type: "sight" },
                    { time: "19:00", end: "", title: "還車", desc: "結束自駕", icon: "fa-key", type: "transport", highlight: true },
                    { time: "18:09", end: "20:09", title: "狸小路", desc: "藥妝、晚餐", icon: "fa-store", type: "food" }
                ]
            },
             {
                day: 5, date: "2026-03-23", title: "浪漫小樽 · 最後採買", color: "border-teal-500",
                events: [
                    { time: "09:13", end: "10:13", title: "小樽站前", desc: "搭乘 JR 前往", icon: "fa-train", type: "transport" },
                    { time: "10:26", end: "12:26", title: "小樽運河", desc: "玻璃哨子館、甜點", icon: "fa-camera-retro", type: "sight" },
                    { time: "12:58", end: "13:28", title: "住吉神社", desc: "參拜", icon: "fa-torii-gate", type: "sight" },
                    { time: "15:01", end: "16:01", title: "北海道神宮", desc: "札幌市區參拜", icon: "fa-gopuram", type: "sight" },
                    { time: "17:38", end: "18:38", title: "札幌一粒庵", desc: "米其林拉麵晚餐", icon: "fa-bowl-food", type: "food" }
                ]
            },
            {
                day: 6, date: "2026-03-24", title: "再見北海道", color: "border-slate-500",
                events: [
                    { time: "06:18", end: "", title: "飯店出發", desc: "搭乘機場快線", icon: "fa-suitcase-rolling", type: "transport" },
                    { time: "07:31", end: "09:31", title: "新千歲機場", desc: "最後採買、登機", icon: "fa-plane", type: "transport" },
                    { time: "13:31", end: "", title: "抵達台灣", desc: "溫暖的家", icon: "fa-house", type: "transport" }
                ]
            }
        ];

        const spots = [
            { name: "五稜郭塔", lat: 41.7956, lng: 140.7538, desc: "俯瞰星形要塞的最佳地點，冬季點燈如夢似幻。" },
            { name: "函館山", lat: 41.7592, lng: 140.7041, desc: "世界三大夜景，地形獨特的百萬夜景。" },
            { name: "金森紅磚倉庫", lat: 41.7667, lng: 140.7169, desc: "明治時代的港口倉庫，現為購物美食區。" },
            { name: "有珠山纜車", lat: 42.5398, lng: 140.8601, desc: "可眺望洞爺湖與昭和新山的活火山。" },
            { name: "旭山動物園", lat: 43.7687, lng: 142.4800, desc: "全日本最受歡迎的動物園，企鵝散步是必看重點。" },
            { name: "白金青池", lat: 43.4938, lng: 142.6145, desc: "枯木與蒂芬妮藍的池水，冬季有點燈活動。" },
            { name: "小樽運河", lat: 43.1994, lng: 140.9959, desc: "充滿懷舊風情，沿岸煤氣燈在黃昏時分最美。" },
            { name: "北海道神宮", lat: 43.0545, lng: 141.3077, desc: "北海道總鎮守，被森林包圍的莊嚴神社。" }
        ];

        const defaultChecklist = ["護照", "網卡/Wifi機", "充電線", "日幣錢包", "行動電源", "常備藥品", "保暖衣物", "駕照日文譯本"];

        let activeDay = 1;

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', () => {
            // Splash Screen
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('fade-out');
            }, 1500);

            // Render Modules
            renderDaySelector();
            renderItinerary();
            initMap();
            renderGuideCards();
            loadChecklist();
            loadMemo();
            loadExpenses();
            updateCountdown();
        });

        // ================= FUNCTIONS =================

        // Helper: Calculate duration between two HH:MM strings
        function getDuration(start, end) {
            if (!start || !end) return "";
            const [h1, m1] = start.split(':').map(Number);
            const [h2, m2] = end.split(':').map(Number);
            let diffMins = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (diffMins < 0) diffMins += 24 * 60; // Handle overnight if needed
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            
            let result = "";
            if (hours > 0) result += `${hours}時`;
            if (mins > 0) result += `${mins}分`;
            return result || "0分";
        }

        // Tab Switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-btn[data-target="${tabId}"]`).classList.add('active');

            // Update Header Title
            const titles = {
                'plan': ['行程總覽', 'Day 1 - Day 6'],
                'guide': ['深度導覽', '景點介紹'],
                'wallet': ['旅費管理', '記帳 & 匯率'],
                'lists': ['清單筆記', '行前 & 備忘'],
                'info': ['實用資訊', '緊急 & 規範']
            };
            document.getElementById('page-title').innerText = titles[tabId][0];
            document.getElementById('page-subtitle').innerText = titles[tabId][1];

            // Re-render map if guide tab (Leaflet needs resize trigger)
            if(tabId === 'guide' && window.mapInstance) {
                setTimeout(() => window.mapInstance.invalidateSize(), 300);
            }
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector-container');
            let html = '';
            itinerary.forEach((day, index) => {
                const isActive = (index + 1) === activeDay;
                html += `
                    <button onclick="setActiveDay(${index + 1})" class="day-btn shrink-0 px-4 py-2 rounded-full border border-slate-200 text-sm font-bold transition ${isActive ? 'active' : 'bg-white text-slate-500'}">
                        Day ${day.day}
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        function setActiveDay(day) {
            activeDay = day;
            renderDaySelector();
            renderItinerary();
        }

        // Render Itinerary (Modified for Single Day View)
        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            const day = itinerary.find(d => d.day === activeDay);
            
            if (!day) return;

            let eventsHtml = '';
            day.events.forEach((evt, index) => {
                const isLast = index === day.events.length - 1;
                const highlightClass = evt.highlight ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'border-l-2 border-slate-200';
                
                // Generate Nav Link (Google Maps Search Fallback)
                const navLink = evt.link || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' 北海道')}`;
                
                // Duration
                const duration = getDuration(evt.time, evt.end);
                const durationHtml = duration ? `<span class="text-[10px] text-slate-400 ml-2"><i class="fa-regular fa-clock"></i> ${duration}</span>` : '';

                // Transport Badge
                const isTransport = evt.type === 'transport';
                const transportBadge = isTransport ? `<span class="inline-block bg-slate-100 text-slate-600 text-[10px] px-2 py-0.5 rounded mr-2 mb-1"><i class="fa-solid fa-route mr-1"></i>交通移動</span>` : '';

                eventsHtml += `
                    <div class="relative pl-6 pb-6 ${isLast ? '' : ''}">
                        <!-- Timeline Line -->
                        <div class="absolute left-[7px] top-2 bottom-0 w-[2px] bg-slate-200 ${isLast ? 'h-0' : ''}"></div>
                        <!-- Dot -->
                        <div class="absolute left-0 top-2 w-4 h-4 rounded-full bg-white border-2 border-slate-300 flex items-center justify-center text-[8px] z-10">
                            <div class="w-1.5 h-1.5 rounded-full ${evt.highlight ? 'bg-yellow-500' : 'bg-slate-300'}"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 ${evt.highlight ? 'ring-1 ring-yellow-200' : ''}">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center">
                                    <div class="font-mono text-xs font-bold text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded">${evt.time} ${evt.end ? `- ${evt.end}` : ''}</div>
                                    ${durationHtml}
                                </div>
                                <i class="fa-solid ${evt.icon} text-slate-300 text-sm"></i>
                            </div>
                            
                            ${transportBadge}

                            <div class="font-bold text-slate-700 text-lg flex items-center flex-wrap leading-tight">
                                ${evt.title}
                            </div>
                            
                            <div class="text-xs text-slate-500 mt-1 leading-relaxed">${evt.desc}</div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-3 flex gap-2 border-t border-slate-100 pt-2">
                                <a href="${navLink}" target="_blank" class="flex-1 text-center bg-sky-50 text-sky-600 text-xs font-bold py-2 rounded-lg hover:bg-sky-100 transition">
                                    <i class="fa-solid fa-location-arrow mr-1"></i> 導航
                                </a>
                                ${evt.link ? `<a href="${evt.link}" target="_blank" class="flex-1 text-center bg-green-50 text-green-600 text-xs font-bold py-2 rounded-lg hover:bg-green-100 transition"><i class="fa-solid fa-circle-info mr-1"></i> 詳情</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `
                <div class="animate-fadeIn">
                    <div class="flex items-baseline gap-2 mb-4 px-1">
                        <h2 class="text-xl font-jp font-bold text-slate-800">Day ${day.day}</h2>
                        <span class="text-xs text-slate-400 font-bold tracking-wide">${day.date}</span>
                    </div>
                    <div class="text-sm font-bold text-slate-600 mb-6 bg-slate-100 inline-block px-4 py-1.5 rounded-full mx-1 shadow-sm border border-slate-200">
                        ${day.title}
                    </div>
                    <div class="ml-1">
                        ${eventsHtml}
                    </div>
                </div>
            `;
        }

        // Map & Guide
        function initMap() {
            // Hakodate Center approximate
            window.mapInstance = L.map('map').setView([42.5, 141.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OSM'
            }).addTo(window.mapInstance);

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#0EA5E9;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)'></div>",
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            spots.forEach(spot => {
                L.marker([spot.lat, spot.lng], {icon: icon})
                .addTo(window.mapInstance)
                .bindPopup(`<b class="font-sans">${spot.name}</b><br><span class="text-xs">${spot.desc}</span>`);
            });
        }

        // Helper to generate SVG illustrations
        function getSpotIllustration(name) {
            const baseClass = "w-full h-full drop-shadow-sm transform hover:scale-105 transition duration-500";
            
            if (name.includes("五稜郭")) { // Star Fort
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <circle cx="50" cy="50" r="45" fill="#E0F2FE"/>
                    <path d="M50 15 L60 40 L88 40 L65 58 L74 85 L50 68 L26 85 L35 58 L12 40 L40 40 Z" fill="#FFF" stroke="#94A3B8" stroke-width="2"/>
                    <path d="M50 25 L55 42 L75 42 L60 54 L65 72 L50 62 L35 72 L40 54 L25 42 L45 42 Z" fill="#FCD34D"/>
                </svg>`;
            } else if (name.includes("函館山")) { // Night View
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <circle cx="50" cy="50" r="45" fill="#1E293B"/>
                    <path d="M10 80 Q50 20 90 80 Z" fill="#334155"/>
                    <circle cx="20" cy="30" r="1.5" fill="#FFF" class="animate-pulse"/>
                    <circle cx="70" cy="25" r="1.5" fill="#FFF" class="animate-pulse" style="animation-delay: 0.5s"/>
                    <circle cx="50" cy="15" r="1.5" fill="#FFF" class="animate-pulse" style="animation-delay: 1s"/>
                    <path d="M30 80 Q50 60 70 80" fill="#F59E0B" opacity="0.8"/>
                    <circle cx="40" cy="70" r="1" fill="#FCD34D"/>
                    <circle cx="60" cy="72" r="1" fill="#FCD34D"/>
                </svg>`;
            } else if (name.includes("紅磚倉庫")) { // Brick Warehouse
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <rect width="100" height="100" fill="#F1F5F9"/>
                    <path d="M20 40 L20 80 L80 80 L80 40 L50 20 Z" fill="#B91C1C"/>
                    <rect x="30" y="50" width="15" height="30" fill="#7F1D1D" rx="2"/>
                    <rect x="55" y="50" width="15" height="30" fill="#7F1D1D" rx="2"/>
                    <line x1="20" y1="40" x2="80" y2="40" stroke="#FFF" stroke-width="1" stroke-dasharray="4 2"/>
                    <line x1="20" y1="50" x2="80" y2="50" stroke="#FFF" stroke-width="1" stroke-dasharray="4 2"/>
                    <line x1="20" y1="60" x2="80" y2="60" stroke="#FFF" stroke-width="1" stroke-dasharray="4 2"/>
                </svg>`;
            } else if (name.includes("有珠山")) { // Ropeway
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                     <circle cx="50" cy="50" r="45" fill="#ECFEFF"/>
                    <line x1="0" y1="30" x2="100" y2="50" stroke="#64748B" stroke-width="2"/>
                    <rect x="40" y="35" width="24" height="20" rx="4" fill="#EF4444"/>
                    <rect x="44" y="40" width="16" height="8" fill="#FFF" opacity="0.5"/>
                    <line x1="52" y1="35" x2="52" y2="30" stroke="#64748B" stroke-width="2"/>
                    <path d="M10 100 Q50 60 90 100" fill="#10B981" opacity="0.3"/>
                </svg>`;
            } else if (name.includes("動物園")) { // Penguin
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <circle cx="50" cy="50" r="45" fill="#E0F7FA"/>
                    <ellipse cx="50" cy="55" rx="20" ry="30" fill="#334155"/>
                    <ellipse cx="50" cy="58" rx="14" ry="24" fill="#FFF"/>
                    <circle cx="45" cy="45" r="2" fill="#000"/>
                    <circle cx="55" cy="45" r="2" fill="#000"/>
                    <path d="M47 50 L53 50 L50 55 Z" fill="#F59E0B"/>
                    <path d="M35 75 L45 75 L40 80 Z" fill="#F59E0B"/>
                    <path d="M55 75 L65 75 L60 80 Z" fill="#F59E0B"/>
                    <path d="M20 20 L25 25 M30 15 L35 20 M80 20 L75 25" stroke="#94A3B8" stroke-width="2"/>
                </svg>`;
            } else if (name.includes("青池")) { // Blue Pond
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <rect width="100" height="100" fill="#06B6D4"/>
                    <line x1="20" y1="90" x2="20" y2="40" stroke="#FFF" stroke-width="3" stroke-linecap="round"/>
                    <line x1="40" y1="95" x2="40" y2="25" stroke="#FFF" stroke-width="4" stroke-linecap="round"/>
                    <line x1="65" y1="90" x2="65" y2="35" stroke="#FFF" stroke-width="3" stroke-linecap="round"/>
                    <line x1="85" y1="100" x2="85" y2="50" stroke="#FFF" stroke-width="2" stroke-linecap="round"/>
                    <path d="M0 80 Q25 75 50 80 T100 80" stroke="#FFF" stroke-width="1" fill="none" opacity="0.3"/>
                    <path d="M0 90 Q25 85 50 90 T100 90" stroke="#FFF" stroke-width="1" fill="none" opacity="0.3"/>
                </svg>`;
            } else if (name.includes("運河")) { // Canal
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                     <rect width="100" height="100" fill="#1E293B"/>
                    <path d="M0 60 Q25 55 50 60 T100 60 V100 H0 Z" fill="#3B82F6"/>
                    <rect x="45" y="20" width="6" height="40" fill="#475569"/>
                    <circle cx="48" cy="20" r="8" fill="#FCD34D" opacity="0.8"/>
                    <circle cx="48" cy="20" r="4" fill="#FFF" opacity="0.9"/>
                    <path d="M0 100 L100 100 L100 65 L0 65" fill="url(#grad1)" opacity="0.3"/>
                </svg>`;
            } else if (name.includes("神宮")) { // Shrine
                return `<svg viewBox="0 0 100 100" class="${baseClass}">
                    <circle cx="50" cy="50" r="45" fill="#ECFDF5"/>
                    <rect x="25" y="25" width="50" height="4" fill="#DC2626" rx="1"/>
                    <rect x="20" y="18" width="60" height="5" fill="#DC2626" rx="1"/>
                    <rect x="35" y="25" width="6" height="55" fill="#DC2626"/>
                    <rect x="59" y="25" width="6" height="55" fill="#DC2626"/>
                    <rect x="32" y="78" width="12" height="2" fill="#9CA3AF"/>
                    <rect x="56" y="78" width="12" height="2" fill="#9CA3AF"/>
                    <path d="M30 35 L70 35" stroke="#DC2626" stroke-width="2"/>
                     <circle cx="15" cy="15" r="2" fill="#F472B6" opacity="0.6"/>
                     <circle cx="85" cy="20" r="3" fill="#F472B6" opacity="0.6"/>
                </svg>`;
            }
            // Default
            return `<svg viewBox="0 0 100 100" class="${baseClass}">
                <rect width="100" height="100" fill="#E2E8F0"/>
                <circle cx="50" cy="40" r="15" fill="#CBD5E1"/>
                <path d="M20 90 Q50 40 80 90" fill="#CBD5E1"/>
            </svg>`;
        }

        function renderGuideCards() {
            const container = document.getElementById('guide-cards');
            let html = '';
            spots.forEach(spot => {
                const illustration = getSpotIllustration(spot.name);
                
                html += `
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100 flex h-32">
                    <div class="w-1/3 bg-slate-50 relative flex items-center justify-center p-2 border-r border-slate-100">
                         ${illustration}
                    </div>
                    <div class="w-2/3 p-4 flex flex-col justify-center relative">
                        <!-- Decorative background icon opacity -->
                        <i class="fa-solid fa-location-dot absolute right-2 bottom-2 text-slate-100 text-6xl -z-0"></i>
                        
                        <h4 class="font-bold text-slate-700 font-jp mb-1 text-lg z-10">${spot.name}</h4>
                        <p class="text-xs text-slate-500 leading-relaxed line-clamp-2 z-10">${spot.desc}</p>
                        
                        <div class="mt-auto pt-2 z-10 flex gap-2">
                             <a href="https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}" target="_blank" class="text-[10px] bg-sky-50 text-sky-600 font-bold border border-sky-100 px-3 py-1.5 rounded-full hover:bg-sky-100 transition flex items-center">
                                <i class="fa-solid fa-location-arrow mr-1"></i> 導航
                            </a>
                        </div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        // ================= WALLET LOGIC =================
        let currentRate = 0.215;

        function updateRate() {
            currentRate = parseFloat(document.getElementById('exchange-rate').value) || 0.215;
            calculate();
        }

        function appendCalc(val) {
            document.getElementById('calc-input').value += val;
        }

        function calculate() {
            const input = document.getElementById('calc-input').value;
            try {
                // Security Note: In a real public app, write a parser. For this personal tool, careful eval is acceptable.
                // Allow only numbers and math operators
                if(/^[0-9+\-*/().\s]+$/.test(input) || input === '') {
                    const jpy = input ? eval(input) : 0;
                    document.getElementById('calc-result').innerText = Math.round(jpy * currentRate).toLocaleString();
                }
            } catch (e) {
                // Ignore incomplete expressions
            }
        }
        
        // Auto calc on typing
        document.getElementById('calc-input').addEventListener('input', calculate);

        // Expense Tracker
        let tempImageBase64 = null;

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Compress Image to canvas
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        tempImageBase64 = canvas.toDataURL('image/jpeg', 0.6); // Compress
                        
                        // Show Preview
                        const preview = document.getElementById('temp-preview');
                        preview.src = tempImageBase64;
                        document.getElementById('image-preview-area').classList.remove('hidden');
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const type = document.querySelector('input[name="payment-type"]:checked').value;
            
            if(!item || !amount) return alert('請輸入項目與金額');

            const expenses = JSON.parse(localStorage.getItem('hokkaido_expenses') || '[]');
            expenses.unshift({
                id: Date.now(),
                item,
                amount,
                type,
                img: tempImageBase64,
                date: new Date().toLocaleString()
            });

            localStorage.setItem('hokkaido_expenses', JSON.stringify(expenses));
            
            // Reset
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            tempImageBase64 = null;
            document.getElementById('image-preview-area').classList.add('hidden');
            
            loadExpenses();
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('hokkaido_expenses') || '[]');
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let total = 0;

            expenses.forEach(ex => {
                total += parseFloat(ex.amount);
                const isCash = ex.type === 'cash';
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3">
                        <div class="w-12 h-12 bg-slate-100 rounded-lg flex-shrink-0 overflow-hidden flex items-center justify-center">
                            ${ex.img ? `<img src="${ex.img}" class="w-full h-full object-cover" onclick="viewImage('${ex.img}')">` : '<i class="fa-solid fa-receipt text-slate-300"></i>'}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-bold text-slate-700">${ex.item}</span>
                                <span class="font-mono font-bold text-slate-800">¥${ex.amount.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-[10px] px-2 py-0.5 rounded ${isCash ? 'bg-green-100 text-green-600' : 'bg-purple-100 text-purple-600'}">
                                    ${isCash ? '現金' : '信用卡'}
                                </span>
                                <span class="text-xs text-slate-400">NT$ ${Math.round(ex.amount * currentRate).toLocaleString()}</span>
                            </div>
                        </div>
                         <button onclick="deleteExpense(${ex.id})" class="text-slate-300 hover:text-red-400 px-2"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });
            document.getElementById('total-jpy').innerText = `¥${total.toLocaleString()}`;
        }

        function deleteExpense(id) {
            if(!confirm('確定刪除?')) return;
            const expenses = JSON.parse(localStorage.getItem('hokkaido_expenses') || '[]');
            const newExpenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('hokkaido_expenses', JSON.stringify(newExpenses));
            loadExpenses();
        }

        function viewImage(src) {
            // Simple overlay viewer logic could go here, for now just basic
            const w = window.open("");
            w.document.write(`<img src="${src}" style="width:100%">`);
        }

        // ================= LISTS LOGIC =================
        function loadChecklist() {
            let data = JSON.parse(localStorage.getItem('hokkaido_checklist') || 'null');
            if (!data) {
                data = defaultChecklist.map(item => ({ text: item, done: false }));
                localStorage.setItem('hokkaido_checklist', JSON.stringify(data));
            }
            
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            
            data.forEach((item, index) => {
                container.innerHTML += `
                    <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg transition">
                        <input type="checkbox" onchange="toggleCheck(${index})" ${item.done ? 'checked' : ''} class="w-5 h-5 rounded text-sky-500 focus:ring-sky-200 border-slate-300">
                        <span class="${item.done ? 'line-through text-slate-400' : 'text-slate-700'} text-sm">${item.text}</span>
                    </label>
                `;
            });
        }

        function toggleCheck(index) {
            const data = JSON.parse(localStorage.getItem('hokkaido_checklist'));
            data[index].done = !data[index].done;
            localStorage.setItem('hokkaido_checklist', JSON.stringify(data));
            loadChecklist();
        }

        function addCheckItem() {
            const val = document.getElementById('new-check-item').value;
            if(!val) return;
            const data = JSON.parse(localStorage.getItem('hokkaido_checklist'));
            data.push({ text: val, done: false });
            localStorage.setItem('hokkaido_checklist', JSON.stringify(data));
            document.getElementById('new-check-item').value = '';
            loadChecklist();
        }

        function loadMemo() {
            const memo = localStorage.getItem('hokkaido_memo') || '';
            document.getElementById('memo-area').value = memo;
            parseMemoLinks(memo);
        }

        function saveMemo() {
            const val = document.getElementById('memo-area').value;
            localStorage.setItem('hokkaido_memo', val);
            parseMemoLinks(val);
            alert('已儲存備忘錄');
        }

        function parseMemoLinks(text) {
            const container = document.getElementById('memo-links');
            container.innerHTML = '';
            // Regex to find URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            
            if(matches) {
                matches.forEach(url => {
                    container.innerHTML += `
                        <a href="${url}" target="_blank" class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-yellow-200 truncate max-w-[150px]">
                            <i class="fa-solid fa-link"></i> 連結
                        </a>
                    `;
                });
            }
        }

        // ================= UTILS =================
        function updateCountdown() {
            const tripStart = new Date("2026-03-19T00:00:00").getTime();
            const now = new Date().getTime();
            const distance = tripStart - now;
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            
            if (distance < 0) {
                document.getElementById('countdown').innerText = "旅程進行中";
            } else {
                document.getElementById('countdown').innerText = `倒數 ${days} 天`;
            }
        }

        function clearAllData() {
            if(confirm("確定要清除所有記帳和筆記資料嗎？此操作無法復原。")) {
                localStorage.removeItem('hokkaido_expenses');
                localStorage.removeItem('hokkaido_memo');
                localStorage.removeItem('hokkaido_checklist');
                location.reload();
            }
        }
    </script>
</body>
</html>